<script lang="ts">
  import PhoneFrame from '$lib/components/PhoneFrame.svelte';
  let email = '';
  let password = '';
  let name = '';
  let loading = $state(false);
  let error = $state('');

  async function register(e: Event) {
    e.preventDefault();
    loading = true;
    error = '';
    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, name }), credentials: 'include'
      });
      if (!res.ok) throw new Error('注册失败');
      location.href = '/';
    } catch (err) {
      error = err instanceof Error ? err.message : '注册失败';
    } finally { loading = false; }
  }

  function backHome(){ location.href = '/'; }
</script>

<PhoneFrame showNav={false}>
  <svelte:fragment slot="header">
    <div class="top-bar">
      <button class="icon-button" aria-label="返回首页" on:click={backHome}>←</button>
      <h2 class="top-bar-title">注册</h2>
      <span class="ghost-button"></span>
    </div>
  </svelte:fragment>

  <section class="hero">
    <h1>Willkommen!</h1>
    <p class="subtitle">创建你的新账户。</p>
  </section>

  <form class="form" on:submit|preventDefault={register}>
    {#if error}<p class="error">{error}</p>{/if}
    <label class="field">
      <span class="icon">📧</span>
      <input type="email" placeholder="邮箱" bind:value={email} required />
    </label>
    <label class="field">
      <span class="icon">🙂</span>
      <input type="text" placeholder="昵称（可选）" bind:value={name} />
    </label>
    <label class="field">
      <span class="icon">🔒</span>
      <input type="password" placeholder="密码（至少 6 位）" bind:value={password} minlength="6" required />
    </label>
    <button class="submit" type="submit" disabled={loading}>{loading ? '处理中…' : '注册'}</button>
    <a class="forgot" href="/login">已有账号？去登录</a>
  </form>
</PhoneFrame>

<style>
  :global(html, body){ background:#ffffff }
  .hero{ margin: 4svh auto 16px; text-align:center; max-width:560px; padding:0 8px }
  .hero h1{ margin:.4rem 0; font-size:40px; font-weight:900; letter-spacing:.02em }
  .subtitle{ margin:0; color:#666; font-size:16px }

  .form{ max-width:640px; margin:16px auto; display:grid; gap:14px; padding:0 8px }
  .field{ display:grid; grid-template-columns:40px 1fr; align-items:center; gap:8px; padding:12px 14px; border:1px solid #e3e6ef; border-radius:14px; background:#fff }
  .field input{ border:none; outline:none; font-size:16px; padding:8px 4px }
  .icon{ width:28px; height:28px; display:grid; place-items:center; color:#8c93a6; font-size:18px }
  .submit{ height:54px; border:none; border-radius:12px; background: linear-gradient(180deg,#2f7bff,#1e63ff); color:#fff; font-weight:800; letter-spacing:.05em; cursor:pointer; box-shadow:0 10px 24px rgba(30,99,255,.25) }
  .submit:disabled{ opacity:.7; cursor:not-allowed }
  .error{ color:#d12d42; font-weight:600 }
  .forgot{ text-align:center; color:#1e63ff; font-weight:700; margin-top: 8px }
</style>
